<script>
  try {
    const cfg = JSON.parse(document.querySelector("meta[name=cfg]").content);
    if (firebase.apps.length === 0) {
      firebase.initializeApp(cfg);
    }
  } catch (e) {
    document.getElementById("msg").textContent = "⚠ Firebase config 読み込み失敗";
  }

  const auth = firebase.auth();
  const twitterProvider = new firebase.auth.TwitterAuthProvider();
  const recaptcha = new firebase.auth.RecaptchaVerifier("recaptcha-container", { size: "invisible" });

  let confirmationResult = null;  // ← グローバル定義

  function pwLogin() {
    const em = email.value.trim(), pw = pass.value;
    if (!em || !pw) return msg.textContent = "Email と PW を入力";
    auth.signInWithEmailAndPassword(em, pw).catch(err => {
      if (err.code === "auth/user-not-found") return auth.createUserWithEmailAndPassword(em, pw);
      throw err;
    })
    .then(r => r.user.getIdToken())
    .then(tok => window.parent.postMessage({ token: tok }, "*"))
    .catch(e => msg.textContent = e.message);
  }

  function sendLink() {
    const em = email.value.trim();
    if (!em) return msg.textContent = "Email を入力";
    localStorage.setItem("link_email_for_login", em);
    auth.sendSignInLinkToEmail(em, {
      url: "https://pokerapp-l57n.onrender.com",
      handleCodeInApp: true
    }).then(() => msg.textContent = "メールを確認してください")
      .catch(e => msg.textContent = e.message);
  }

  window.addEventListener("DOMContentLoaded", () => {
    if (auth.isSignInWithEmailLink(location.href)) {
      const em = localStorage.getItem("link_email_for_login") || prompt("Email 入力");
      if (!em) return;
      auth.signInWithEmailLink(em, location.href)
        .then(r => r.user.getIdToken())
        .then(tok => {
          localStorage.removeItem("link_email_for_login");
          window.parent.postMessage({ token: tok }, "*");
        })
        .catch(e => msg.textContent = e.message);
    }
  });

  function sendSMS() {
    const ph = phone.value.trim();
    if (!ph) return msg.textContent = "電話番号を入力";
    auth.signInWithPhoneNumber(ph, recaptcha)
      .then(res => { confirmationResult = res; msg.textContent = "SMS 送信済み"; })
      .catch(e => msg.textContent = e.message);
  }

  function verifySMS() {
    if (!confirmationResult) {
      msg.textContent = "先に SMS を送信してください";
      return;
    }
    confirmationResult.confirm(otp.value.trim())
      .then(r => r.user.getIdToken())
      .then(tok => window.parent.postMessage({ token: tok }, "*"))
      .catch(e => msg.textContent = e.message);
  }

  function twitterLogin() {
    auth.signInWithPopup(twitterProvider)
      .then(r => r.user.getIdToken())
      .then(tok => window.parent.postMessage({ token: tok }, "*"))
      .catch(e => msg.textContent = e.message);
  }

  function anonLogin() {
    auth.signInAnonymously()
      .then(r => r.user.getIdToken())
      .then(tok => window.parent.postMessage({ token: tok }, "*"))
      .catch(e => msg.textContent = e.message);
  }
</script>
