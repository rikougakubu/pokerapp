<script>
  let auth = null;
  let confirmationResult = null;

  // Firebase 初期化と依存オブジェクトの定義
  window.addEventListener("DOMContentLoaded", () => {
    try {
      const cfg = JSON.parse(document.querySelector("meta[name=cfg]").content);
      firebase.initializeApp(cfg);
      auth = firebase.auth();

      // Recaptcha は初期化後に生成
      window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier("recaptcha-container", {
        size: "invisible"
      });

      // Email Link によるログイン
      if (auth.isSignInWithEmailLink(location.href)) {
        const em = localStorage.getItem("link_email_for_login") || prompt("Email 入力");
        if (!em) return;
        auth.signInWithEmailLink(em, location.href)
            .then(r => r.user.getIdToken())
            .then(tok => {
              localStorage.removeItem("link_email_for_login");
              window.parent.postMessage({ token: tok }, "*");
            })
            .catch(e => msg.textContent = e.message);
      }

    } catch (e) {
      document.getElementById("msg").textContent = "⚠ Firebase config 読み込み失敗: " + e.message;
    }
  });

  // 以下の関数は auth が初期化された後で使えるように定義
  function pwLogin() {
    if (!auth) return msg.textContent = "auth 未初期化";
    const em = email.value.trim(), pw = pass.value;
    if (!em || !pw) return msg.textContent = "Email と PW を入力";
    auth.signInWithEmailAndPassword(em, pw)
        .catch(err => {
          if (err.code === "auth/user-not-found") {
            return auth.createUserWithEmailAndPassword(em, pw);
          }
          throw err;
        })
        .then(r => r.user.getIdToken())
        .then(tok => window.parent.postMessage({ token: tok }, "*"))
        .catch(e => msg.textContent = e.message);
  }

  function sendLink() {
    if (!auth) return msg.textContent = "auth 未初期化";
    const em = email.value.trim();
    if (!em) return msg.textContent = "Email を入力";
    localStorage.setItem("link_email_for_login", em);
    auth.sendSignInLinkToEmail(em, {
      url: "https://pokerapp-l57n.onrender.com",
      handleCodeInApp: true
    })
    .then(() => msg.textContent = "メールを確認してください")
    .catch(e => msg.textContent = e.message);
  }

  function sendSMS() {
    if (!auth || !window.recaptchaVerifier) return msg.textContent = "認証未初期化";
    const ph = phone.value.trim();
    if (!ph) return msg.textContent = "電話番号を入力";
    auth.signInWithPhoneNumber(ph, window.recaptchaVerifier)
        .then(res => {
          confirmationResult = res;
          msg.textContent = "SMS 送信済み";
        })
        .catch(e => msg.textContent = e.message);
  }

  function verifySMS() {
    if (!confirmationResult) return msg.textContent = "先に SMS を送信";
    confirmationResult.confirm(otp.value.trim())
        .then(r => r.user.getIdToken())
        .then(tok => window.parent.postMessage({ token: tok }, "*"))
        .catch(e => msg.textContent = e.message);
  }

  function twitterLogin() {
    if (!auth) return msg.textContent = "auth 未初期化";
    const twitterProvider = new firebase.auth.TwitterAuthProvider();
    auth.signInWithPopup(twitterProvider)
        .then(r => r.user.getIdToken())
        .then(tok => window.parent.postMessage({ token: tok }, "*"))
        .catch(e => msg.textContent = e.message);
  }

  function anonLogin() {
    if (!auth) return msg.textContent = "auth 未初期化";
    auth.signInAnonymously()
        .then(r => r.user.getIdToken())
        .then(tok => window.parent.postMessage({ token: tok }, "*"))
        .catch(e => msg.textContent = e.message);
  }
</script>
