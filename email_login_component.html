<!DOCTYPE html>
<html>
<head>
  <!-- 互換ビルド v9.x ― ESM でなく window.firebase グローバル -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <!-- Python がここを書き換える -->
  <meta name="cfg" content=''>
  <style>
    body{font-family:sans-serif;text-align:center;margin:0;padding:14px;}
    input{margin:4px;padding:6px;width:200px;border:1px solid #aaa;border-radius:4px;}
    button{padding:6px 12px;margin:4px;border:none;border-radius:4px;background:#4285f4;color:#fff;cursor:pointer;}
    #msg{font-size:0.9em;color:#d33;height:1.2em;margin-top:6px;}
  </style>
</head>
<body>
  <h4>Email Login</h4>
  <input id="email" type="email" placeholder="Email"><br>
  <input id="pass"  type="password" placeholder="Password(任意)"><br>
  <button onclick="login()">Sign‑in</button>
  <button onclick="sendLink()">Magic Link</button>
  <hr style="width:70%;margin:12px auto">
  <button style="background:#1d9bf0" onclick="twitterLogin()">Twitter でログイン</button>
  <p id="msg"></p>

<script>
  /* ---------- Firebase 初期化 ---------- */
  try{
    const cfg = JSON.parse(document.querySelector('meta[name=cfg]').content);
    firebase.initializeApp(cfg);
  }catch(e){
    document.getElementById('msg').textContent="⚠ Firebase config 読み込み失敗";
  }

  const auth = firebase.auth();
  const twitterProvider = new firebase.auth.TwitterAuthProvider();

  /* ---------- 自動 sign‑in (Email Link) ---------- */
  window.addEventListener("DOMContentLoaded", ()=>{
    if (firebase.auth().isSignInWithEmailLink(location.href)){
      const saved = localStorage.getItem("link_email_for_login") || "";
      const em = saved || prompt("Email を入力してください");
      if(!em){ return; }
      auth.signInWithEmailLink(em, location.href)
          .then(r=>r.user.getIdToken())
          .then(tok=>{
            localStorage.removeItem("link_email_for_login");
            window.parent.postMessage({token:tok},"*");
          })
          .catch(e=> msg.textContent=e.message);
    }
  });
  /* ---------- Magic Link ---------- */
function sendLink(){
  const em = email.value.trim();
  if(!em){ msg.textContent="Email を入力"; return; }

  // ★ ここで保存
  localStorage.setItem("link_email_for_login", em);

  auth.sendSignInLinkToEmail(em,{
      url: "https://pokerapp-l57n.onrender.com",   // 固定
      handleCodeInApp: true
  })
  .then(()=> msg.textContent="メールを確認してください")
  .catch(e => msg.textContent=e.message);
}

  /* ---------- Twitter ---------- */
  function twitterLogin(){
    auth.signInWithPopup(twitterProvider)
        .then(r=>r.user.getIdToken())
        .then(tok=> window.parent.postMessage({token:tok},"*"))
        .catch(e=> msg.textContent=e.message);
  }
</script>
</body>
</html>
